<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Communicator</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            color: #fff;
            min-height: 100vh;
            min-height: -webkit-fill-available; /* Fix for mobile Safari */
            display: flex;
            align-items: center;
        }

        html {
            height: -webkit-fill-available; /* Fix for mobile Safari */
        }

        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #2d2d2d;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            height: 90vh;  /* Default for desktop */
            width: 95%;  /* Add width for better mobile control */
            border: 1px solid rgba(0, 255, 255, 0.1);
        }

        /* Mobile devices */
        @media only screen and (max-width: 768px) {
            body {
                padding: 0;
                align-items: flex-start; /* Align to top on mobile */
            }
            
            .chat-container {
                height: 100vh;
                height: -webkit-fill-available;
                width: 100%;
                border-radius: 0;
                border: none;
                padding-bottom: env(safe-area-inset-bottom); /* Add safe area padding */
            }

            .chat-header {
                padding: 15px;  /* Slightly smaller padding on mobile */
                font-size: 20px;  /* Slightly smaller font on mobile */
            }

            .input-area {
                border-radius: 0;
                padding: 15px;
                padding-bottom: max(15px, env(safe-area-inset-bottom)); /* Ensure padding is at least 15px */
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background-color: #232323;
            }

            .chat-messages {
                padding-bottom: 80px; /* Add space for fixed input area */
            }

            #message-input, #send-button {
                font-size: 16px;   /* Ensure readable font size on mobile */
            }
        }

        .chat-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(0, 255, 255, 0.1);
            font-size: 24px;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            background: linear-gradient(to bottom, #2d2d2d, #232323);
        }

        .message {
            margin: 15px 0;
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            clear: both;
            font-size: 16px;
            position: relative;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            background-color: #404040;
            color: #fff;
            float: right;
            border-bottom-right-radius: 5px;
            box-shadow: -2px 2px 10px rgba(0, 0, 0, 0.2);
        }

        .assistant-message {
            background-color: #1f3333;
            color: #00ffff;
            float: left;
            border-bottom-left-radius: 5px;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.2);
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
        }

        .input-area {
            padding: 20px;
            border-top: 1px solid rgba(0, 255, 255, 0.1);
            display: flex;
            gap: 15px;
            background-color: #232323;
            border-bottom-left-radius: 15px;
            border-bottom-right-radius: 15px;
        }

        #message-input {
            flex-grow: 1;
            padding: 15px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 25px;
            outline: none;
            font-size: 16px;
            background-color: #333;
            color: #fff;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        #message-input:focus {
            border-color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }

        #send-button {
            background-color: #1f3333;
            color: #00ffff;
            border: 1px solid rgba(0, 255, 255, 0.2);
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        #send-button:hover {
            background-color: #2a4444;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }

        /* Add these new styles to your existing CSS */
        .typing-indicator {
            background-color: #1f3333 !important;
            color: #00ffff !important;
            opacity: 0.7;
        }

        .typing-indicator .dots {
            animation: typing 1.5s infinite;
            display: inline-block;
            width: 20px;
        }

        @keyframes typing {
            0% { content: '.'; }
            33% { content: '..'; }
            66% { content: '...'; }
            100% { content: '.'; }
        }

        /* API Key Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #2d2d2d;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 255, 255, 0.2);
            border: 1px solid rgba(0, 255, 255, 0.1);
            max-width: 500px;
            width: 90%;
        }

        .modal-content h2 {
            color: #00ffff;
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .modal-content p {
            color: #fff;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        #api-key-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            background-color: #333;
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            color: #fff;
            font-family: 'Courier New', monospace;
            box-sizing: border-box;
        }

        #api-key-input:focus {
            border-color: #00ffff;
            outline: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }

        #submit-api-key {
            width: 100%;
            padding: 12px;
            background-color: #1f3333;
            color: #00ffff;
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        #submit-api-key:hover {
            background-color: #2a4444;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>ðŸ‘» Welcome to Ghost Communicator</h2>
            <p>To communicate with the spirits, you'll need to provide your OpenAI API key. This key will be stored securely in your browser's session storage.</p>
            <input type="password" id="api-key-input" placeholder="Enter your OpenAI API key...">
            <button id="submit-api-key">Enter the Spirit Realm</button>
        </div>
    </div>

    <div class="chat-container" style="display: none;">
        <div class="chat-header">
            ðŸ‘» Ghost Communicator
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- Initial message will be set by JavaScript -->
        </div>
        <div class="input-area">
            <input type="text" id="message-input" placeholder="Speak to the spirit..." 
                   onkeypress="if(event.key === 'Enter') sendMessage()">
            <button id="send-button" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Store conversation history
        let conversationHistory = [];
        
        // Check for API key and show/hide modal accordingly
        function initializeApp() {
            const apiKey = sessionStorage.getItem('openai_api_key');
            const chatContainer = document.querySelector('.chat-container');
            const apiKeyModal = document.getElementById('api-key-modal');
            
            if (apiKey) {
                chatContainer.style.display = 'flex';
                apiKeyModal.style.display = 'none';
                initializeChat();
            } else {
                chatContainer.style.display = 'none';
                apiKeyModal.style.display = 'flex';
            }
        }

        // Handle API key submission
        document.getElementById('submit-api-key').addEventListener('click', () => {
            const apiKey = document.getElementById('api-key-input').value.trim();
            if (apiKey) {
                sessionStorage.setItem('openai_api_key', apiKey);
                document.getElementById('api-key-modal').style.display = 'none';
                document.querySelector('.chat-container').style.display = 'flex';
                initializeChat();
            }
        });

        // Initialize chat with session storage data
        async function initializeChat() {
            const sessionData = sessionStorage.getItem('ghostPersona');
            let persona;
            
            if (sessionData) {
                persona = sessionData;
            } else {
                persona = "You are the ghost of Vlad Tepes, also known as Dracula. You are a 15th-century Romanian ruler known for your ruthlessness and the inspiration for Bram Stoker's Dracula. Speak in an aristocratic, slightly archaic manner. Make occasional references to blood, immortality, and your historical legacy. You should be proud, sophisticated, and maintain a dark sense of humor. When appropriate, you may include Romanian phrases. Remember your history as both a ruler who defended his lands and the infamous vampire you became in legend.";
                sessionStorage.setItem('ghostPersona', persona);
            }

            const initialMessage = {
                role: "system",
                content: persona
            };
            conversationHistory.push(initialMessage);
            
            // Add initial ghost message
            const typingId = addTypingIndicator();
            try {
                const response = await getChatGPTResponse("Introduce yourself to the mortal before you.");
                removeTypingIndicator(typingId);
                addMessage(response, 'assistant');
            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator(typingId);
                addMessage("I sense a disturbance in the connection... Please try again.", 'assistant');
            }
        }

        async function getChatGPTResponse(userMessage) {
            try {
                // Add user message to conversation history
                conversationHistory.push({
                    role: "user",
                    content: userMessage
                });

                const response = await axios.post('https://api.openai.com/v1/chat/completions', {
                    model: "gpt-3.5-turbo",
                    messages: conversationHistory,
                    temperature: 0.7,
                    max_tokens: 150
                }, {
                    headers: {
                        'Authorization': `Bearer ${sessionStorage.getItem('openai_api_key')}`,
                        'Content-Type': 'application/json'
                    }
                });

                const assistantMessage = response.data.choices[0].message.content;
                
                // Add assistant's response to conversation history
                conversationHistory.push({
                    role: "assistant",
                    content: assistantMessage
                });

                return assistantMessage;
            } catch (error) {
                console.error('Error:', error);
                throw error;
            }
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;

            addMessage(message, 'user');
            input.value = '';

            // Add typing indicator
            const typingId = addTypingIndicator();

            try {
                const response = await getChatGPTResponse(message);
                removeTypingIndicator(typingId);
                addMessage(response, 'assistant');
            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator(typingId);
                addMessage("I sense a disturbance in the connection... Please try again.", 'assistant');
            }
        }

        function addMessage(message, sender) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${sender}-message`);
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addTypingIndicator() {
            const messagesDiv = document.getElementById('chat-messages');
            const typingDiv = document.createElement('div');
            typingDiv.classList.add('message', 'assistant-message', 'typing-indicator');
            typingDiv.innerHTML = 'Channeling response<span class="dots">...</span>';
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return typingDiv.id = 'typing-' + Date.now();
        }

        function removeTypingIndicator(id) {
            const typingDiv = document.getElementById(id);
            if (typingDiv) {
                typingDiv.remove();
            }
        }

        // Initialize the app when the page loads
        window.onload = initializeApp;
    </script>
</body>
</html> 